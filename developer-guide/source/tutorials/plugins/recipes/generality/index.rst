Creating a plugin Recipe component
**********************************

Prerequisites
#############
* Dataiku >= 12.0
* Access to a dataiku instance with the "Develop plugins" permissions
* Access to an existing project with the following permissions:
    * "Read project content"
    * "Write project content"

Introduction
############

Creating a custom recipe component is an easy way to add a new recipe to Dataiku via plugins.
Doing so will make your recipe easily accessible alongside standard ones in the `Plugin recipes` section.

All recipes in Dataiku share the same essential function of taking data as input and producing new data as output.
Recipes can operate with three types of data: datasets, managed folders or saved models.
A recipe can even handle multiple types of data at once.
Beyond this, recipes can be further customized to suit specific needs by requesting user input before running the recipe. 
Plugins are divided into a code file and configuration file. 
    
Recipe creation
###############

You will create a recipe for this tutorial and convert it to a plugin component.
As this tutorial focuses only on recipe creation, let's 
re-use the default code provided by Dataiku when you create a Python recipe.


1. Create the ``cars`` dataset by uploading this `CSV file <https://cdn.downloads.dataiku.com/public/website-additional-assets/data/cars.csv>`_ (or you can use any existing dataset).
2. Select the **Python recipe** from the **Code recipes** action panel.
3. Create a new output dataset named ``cars_copy``.
4. Then click on the **Create Recipe** button.

Let's create a plugin from this new recipe: 

1. Still in the recipe code editor, from the **Actions** panel, click **Convert to plugin**.
2. Choose the most suitable option for you (either **New plugin** or **Existing dev plugin**),
3. Enter ``plugin-datasets-copy`` in the **Plugin id** field.
4. Enter ``datasets-copy`` in the **New plugin recipe id**  field.

   .. note:: 
    Several recipes can be nested in one plugin. Choose the name so it can be clearly identified amongst other recipes. 

5. Click on the **Convert** button.


Configuration File: ``recipe.json``
#####################################

:ref:`Code 1<tutorial_plugins_recipes_generality_recipe_generated_json>` is the default configuration file for the custom recipe generated by Dataiku.
This file is divided into four sections: ``meta``, ``inputRoles``, ``outputRoles``, and ``params``.

* The ``meta`` represents the global description of the recipe.
* The ``inputRoles`` describes which input the recipe takes as parameters.
* The ``outputRoles`` describes which output the recipe produces.
* The ``params`` defines which parameters the recipe takes into consideration.

.. dropdown:: Code 1: ``recipe.json``
    :open:

    .. literalinclude:: ./assets/recipe-generated.json
        :language: json
        :caption: Code 1: ``recipe.json``
        :emphasize-lines: 4,20,41,69
        :name: tutorial_plugins_recipes_generality_recipe_generated_json

Meta configuration
==================

In the ``"meta"`` section, you will define the following:

* ``"description"``: the recipe's purpose.
* ``"icon"``: the icon to represent it.
* ``"label"``: the name of the recipe

Using the definition shown in
:ref:`Code 2<tutorial_plugins_recipes_generality_recipe_json_meta>`, 

.. literalinclude:: ./assets/recipe.json
    :language: json
    :caption: Code 2: ``recipe.json``, ``"meta"`` section.
    :lines: 2-6
    :name: tutorial_plugins_recipes_generality_recipe_json_meta
    
Input and ouput configuration
===============================

Each recipe can take some input. The ``"inputRoles"`` section is the place where you will define those inputs.
As a recipe can take more than one input, ``"inputRoles"`` is an array representing those inputs.
Each object in this array will represent one input.

For each object, you have to define the following:

* ``"name"``: the name of the variable in the associated code.
* ``"label"``: title for the input in the UI.
* ``"description"``: description of what this input is for
  (displayed in the UI when the user requires it or in the "Run" screen).
* ``"arity"``: choice between two values: ``"UNARY"`` or ``"NARY"``,
  meaning that this input is composed of one or multiple inputs.
* ``"required"``: whether this input is required or not.
* ``"acceptsDataset"``: whether this input takes a dataset as an input (optional, ``true`` by default).
* ``"acceptsManagedFolder"``: whether this input takes a managed folder as an input (optional, ``false`` by default).
* ``"acceptsSavedModel"``: whether a saved model can be used for this input (optional, ``false`` by default).


For example, if you need only one input, which is the case in our case,
you should define your input like in :ref:`Code 3<tutorial_plugins_recipes_generality_recipe_json_inputRoles>`.

.. literalinclude:: ./assets/recipe.json
    :language: json
    :caption: Code 3: ``recipe.json``, ``"inputRoles""`` section.
    :lines: 7-16
    :name: tutorial_plugins_recipes_generality_recipe_json_inputRoles

The ``"outputRoles"`` section serves the same purpose as the ``"inputRoles"`` section,
except it is dedicated to defining the recipe outputs.

Params configuration
======================

In this section, you will define all the needed parameters for your recipe to run.
:ref:`Refer to this tutorial<tutorial_plugin_recipes_automatic_clipping_parameters_definition>`
which provides more information on the *params* section.

Complete code 
==================
:ref:`Code 4<tutorial_plugins_recipes_generality_recipe_json>`
shows the complete code of the configuration file for the recipe.

.. literalinclude:: ./assets/recipe.json
    :language: json
    :caption: Code 4: ``recipe.json``, ``"inputRoles""`` section.
    :emphasize-lines: 17
    :name: tutorial_plugins_recipes_generality_recipe_json

The highlighted ``"selectableFromDataset"`` parameter allows the recipe to appear in the plugin list, in the action panel, when selecting a dataset. 

.. warning::
    If you omit it, the user has to go into the **+Recipe** button menu to find your plugin, select it,
    and then select the custom recipe.

If you want your recipe to appear when selecting a managed folder or a saved model, you should use ``"selectableFromFolder"`` or ``"selectableFromSavedModel"``, respectively.

.. note::

    You may change the ``"acceptsDataset": true`` parameter into the corresponding type of input in the ``"inputRoles"`` section. 


Code File: ``recipe.py``
#########################

If you look at the generated code (:ref:`Code 5<tutorial_plugins_recipes_generality_generated_py>`),
you will see two blocs.
One is the starter code generated by Dataiku, and the other bloc is your original recipe (the highlighted lines).
You need to adapt your code to fit into the custom recipe pattern.

.. dropdown:: Code 5: Generated python sample ``recipe.py``
    :open:

    .. literalinclude:: ./assets/recipe-generated.py
        :language: python
        :caption: Code 5: generated Python code
        :emphasize-lines: 51-
        :name: tutorial_plugins_recipes_generality_generated_py


The first thing you need to do is change your recipe's input and output.
Previously, your recipe acted on a known dataset.
As you turn it into a custom recipe,
you should get the user input defined in the ``"inputRoles"`` section of the ``recipe.json`` file.

In this file, you have defined ``dataset_to_copy`` as the name of the ``"inputRoles"``,
so you should now extract the name of the dataset by using the code shown in
:ref:`Code 6<tutorial_plugins_recipes_generality_recipe_py_datasets_access>`.

.. literalinclude:: ./assets/recipe.py
    :language: python
    :caption: Code 6: How to access to the dataset specified by the user.
    :lines: 8-12
    :name: tutorial_plugins_recipes_generality_recipe_py_datasets_access


The function :meth:`dataiku.customrecipe.get_input_names_for_role` returns an array
(because the ``inputRole`` object can be defined as ``"NARY"``)
of names defined by the user when filling the form (L. 2).
As your inputRoles (``dataset_to_copy``) is ``"UNARY"``,
you can assume that there will be only one name in the function :meth:`dataiku.customrecipe.get_input_names_for_role`
response (L. 5). So you can easily access to the dataset.

The same process can be applied to the "outputRoles".

Once you have your two datasets (input and output), you must adapt your original code,
as shown in :ref:`Code 7<tutorial_plugins_recipes_generality_recipe_py>`.


.. literalinclude:: ./assets/recipe.py
    :language: python
    :caption: Code 7: Complete code of the custom recipe.
    :name: tutorial_plugins_recipes_generality_recipe_py

Wrapping up
###########

You have completed this tutorial and built your first custom recipe.
Understanding all these basic concepts allows you to create more complex custom recipes.

You can add a parameter to your recipe to only copy a subset of the initial dataset.
:doc:`This tutorial<../recipes-clipping-dataset/index>` could provide helpful ideas and
show a more complex custom recipe dealing with parameters and a valuable algorithm.

Here is the complete version of the code presented in this tutorial:

.. dropdown:: recipe.json

    .. literalinclude:: ./assets/recipe.json
        :language: json

.. dropdown:: recipe.py

    .. literalinclude:: ./assets/recipe.py
        :language: python
